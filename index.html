<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Manager Ultimate V6 (Cicilan & Admin First)</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #121212; color: #ffffff; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        
        /* Navbar & Sidebar */
        .navbar { background-color: #1f1f1f; border-bottom: 1px solid #333; }
        .offcanvas { background-color: #1f1f1f; color: white; }
        .nav-link { color: #ccc; padding: 15px 20px; font-size: 1.1rem; border-radius: 10px; margin-bottom: 5px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background-color: #bb2d3b; color: white; }
        .nav-link i { width: 30px; }

        /* Cards & Inputs */
        .card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .form-control, .form-select { background-color: #2c2c2c; border: 1px solid #444; color: white; }
        .form-control:focus, .form-select:focus { background-color: #333; color: white; border-color: #bb2d3b; box-shadow: none; }
        input, select, textarea { color: white !important; } 

        /* Labels & Texts */
        .form-label, label { color: #ffffff !important; font-weight: 500; opacity: 1 !important; }
        .text-muted { color: #bbbbbb !important; }

        /* Dashboard Boxes */
        .dash-box { padding: 20px; border-radius: 15px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .dash-blue { background: linear-gradient(135deg, #0d6efd, #0a58ca); }
        .dash-orange { background: linear-gradient(135deg, #fd7e14, #ca6510); }
        .dash-green { background: linear-gradient(135deg, #198754, #157347); }

        /* Utilities */
        .text-accent { color: #ff4757; }
        .blink-urgent { animation: blinker 1s linear infinite; color: #ff4d4d; font-weight: bold; }
        @keyframes blinker { 50% { opacity: 0.5; } }
        
        /* Transaction Log Style */
        .log-in { border-left: 4px solid #198754; background-color: rgba(25, 135, 84, 0.1); }
        .log-out { border-left: 4px solid #dc3545; background-color: rgba(220, 53, 69, 0.1); }
        .log-date { font-size: 0.75rem; color: #888; }
        
        /* Checkbox List */
        .source-item { border: 1px solid #444; padding: 10px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .source-item:hover { background-color: #2a2a2a; }
        .source-item.active { border-color: #ff4757; background-color: #2c0b0e; }

        /* Progress Bar for Loan */
        .progress { height: 10px; background-color: #333; border-radius: 5px; }
    </style>
</head>
<body>

    <!-- NAVBAR TOP -->
    <nav class="navbar navbar-dark sticky-top">
        <div class="container-fluid">
            <button class="btn btn-outline-light border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <span class="navbar-brand mb-0 h1 fw-bold text-accent"><i class="fas fa-skull"></i> DEBT MANAGER PRO</span>
            <div style="width: 40px;"></div>
        </div>
    </nav>

    <!-- SIDEBAR MENU -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title fw-bold text-accent">MENU UTAMA</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <nav class="nav flex-column">
                <a class="nav-link active" href="#" onclick="showSection('dashboardSection', this)"><i class="fas fa-tachometer-alt"></i> Dashboard Modal</a>
                <a class="nav-link" href="#" onclick="showSection('activeSection', this)"><i class="fas fa-list-ul"></i> List Utang Aktif</a>
                <a class="nav-link" href="#" onclick="showSection('inputSection', this)"><i class="fas fa-plus-circle"></i> Tambah Utang</a>
                <a class="nav-link" href="#" onclick="showSection('historySection', this)"><i class="fas fa-history"></i> Log Transaksi</a>
                <a class="nav-link" href="#" onclick="showSection('investSection', this)"><i class="fas fa-coins"></i> Kelola Dana</a>
                <hr class="border-secondary">
                <div class="text-center text-muted small mt-4">V6.0 - Cicilan System</div>
            </nav>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="container py-4" style="max-width: 800px;">

        <!-- 0. SECTION: DASHBOARD MODAL -->
        <div id="dashboardSection">
            <h4 class="mb-3 fw-bold border-start border-4 border-info ps-3">STATUS KEUANGAN</h4>
            
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <div class="dash-box dash-blue shadow">
                        <small class="text-white opacity-75">TOTAL ASET (MODAL + PROFIT)</small>
                        <h2 class="fw-bold mb-0" id="dashTotalAsset">Rp 0</h2>
                        <small class="text-white fst-italic mt-1">(Owner + Investor)</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="dash-box dash-orange shadow">
                        <small class="text-white opacity-75">DIPINJAM ORANG</small>
                        <h4 class="fw-bold mb-0" id="dashUsed">Rp 0</h4>
                    </div>
                </div>
                <div class="col-6">
                    <div class="dash-box dash-green shadow">
                        <small class="text-white opacity-75">SALDO READY</small>
                        <h4 class="fw-bold mb-0" id="dashAvailable">Rp 0</h4>
                        <small class="text-white mt-1" style="font-size: 0.7rem;">(Siap Diputar)</small>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="text-accent fw-bold mb-3"><i class="fas fa-chart-pie"></i> Ringkasan Aset</h5>
                    <div class="d-flex justify-content-between border-bottom border-secondary pb-2 mb-2">
                        <span>Aset Owner (Saldo Kita)</span>
                        <span class="text-success fw-bold" id="dashOwnerBalance">Rp 0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Aset Investor (Saldo Mereka)</span>
                        <span class="text-info fw-bold" id="dashInvestorBalance">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. SECTION: LIST UTANG AKTIF -->
        <div id="activeSection" style="display:none;">
            <h4 class="mb-3 fw-bold border-start border-4 border-danger ps-3">TAGIHAN BERJALAN</h4>
            <div id="activeLoanContainer"></div>
            <div id="emptyActiveMsg" class="text-center text-muted py-5" style="display:none;">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i><br>
                Semua uang aman di brankas.
            </div>
        </div>

        <!-- 2. SECTION: INPUT UTANG BARU -->
        <div id="inputSection" style="display:none;">
            <h4 class="mb-3 fw-bold border-start border-4 border-primary ps-3">INPUT KORBAN BARU</h4>
            
            <div class="card">
                <div class="card-body">
                    <form id="loanForm">
                        <!-- MULTI SOURCE SELECTION (COLLAPSIBLE) -->
                        <div class="mb-3">
                            <label class="form-label text-warning fw-bold"><i class="fas fa-wallet"></i> Sumber Dana</label>
                            
                            <button type="button" class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center" onclick="toggleSourceDropdown()">
                                <span id="dropdownLabel">Klik untuk Pilih Sumber Dana...</span>
                                <i class="fas fa-chevron-down" id="dropdownIcon"></i>
                            </button>

                            <div id="sourceListContainer" class="mt-2 p-2 border border-secondary rounded bg-dark" style="display: none;">
                                <!-- Checkboxes populated by JS -->
                            </div>
                            
                            <div class="form-text text-info mt-2" id="totalSelectedFunds">Total Dana Terpilih: Rp 0</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nama Peminjam</label>
                            <input type="text" class="form-control fw-bold text-uppercase" id="borrowerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nomor WhatsApp</label>
                            <input type="number" class="form-control" id="borrowerPhone" placeholder="08..." required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nominal (10k - 100k)</label>
                            <input type="number" class="form-control fw-bold text-accent fs-4" id="amount" placeholder="0" required>
                        </div>
                        
                        <div id="previewBox" class="alert alert-dark border border-secondary" style="display:none;"></div>

                        <button type="submit" class="btn btn-danger w-100 fw-bold py-3 mt-2">
                            <i class="fas fa-save"></i> PROSES PINJAMAN
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 3. SECTION: RIWAYAT & LAPORAN (LOG TRANSAKSI) -->
        <div id="historySection" style="display:none;">
            <h4 class="mb-3 fw-bold border-start border-4 border-success ps-3">LOG TRANSAKSI</h4>
            
            <ul class="nav nav-pills mb-3 nav-fill" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active bg-dark border border-secondary text-white mx-1" onclick="renderTransactions('in')">
                        <i class="fas fa-arrow-down text-success"></i> Uang Masuk
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link bg-dark border border-secondary text-white mx-1" onclick="renderTransactions('out')">
                        <i class="fas fa-arrow-up text-danger"></i> Uang Keluar
                    </button>
                </li>
            </ul>

            <div id="transactionContainer" class="mt-3">
                <!-- Log List -->
            </div>
        </div>

        <!-- 4. SECTION: KELOLA DANA (MODAL & INVESTOR) -->
        <div id="investSection" style="display:none;">
            <h4 class="mb-3 fw-bold border-start border-4 border-warning ps-3">MODAL & INVESTOR</h4>
            
            <!-- Card Input Modal -->
            <div class="card mb-4">
                <div class="card-header bg-dark border-secondary fw-bold text-warning">
                    <i class="fas fa-plus-circle"></i> Tambah Modal Baru
                </div>
                <div class="card-body">
                    <form id="capitalForm">
                        <div class="mb-3">
                            <label class="form-label">Jenis Modal</label>
                            <select class="form-select" id="capitalType">
                                <option value="owner">Modal Sendiri (Owner)</option>
                                <option value="investor">Modal Investor</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" id="capitalAmountLabel">Total Uang Cash (Rp)</label>
                            <input type="number" class="form-control fw-bold text-white fs-4" id="capitalAmount" placeholder="Rp" required>
                        </div>

                        <div id="ownerInputs">
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="adminFeeCheck">
                                <label class="form-check-label text-muted" for="adminFeeCheck">Via Indomaret (Admin Rp 1.500)</label>
                            </div>
                            <div id="smartTopupPreview" class="alert alert-dark border border-secondary mt-2" style="display:none;">
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>Cash Awal:</span> <span id="prevCash">Rp 0</span>
                                </div>
                                <div class="d-flex justify-content-between text-danger small">
                                    <span>Admin:</span> <span>-Rp 1.500</span>
                                </div>
                                <div class="border-top border-secondary my-1"></div>
                                <div class="d-flex justify-content-between fw-bold text-success">
                                    <span>Masuk Saldo:</span> <span id="prevSaldo">Rp 0</span>
                                </div>
                                <div class="d-flex justify-content-between text-warning small mt-1">
                                    <span>Kembalian/Receh:</span> <span id="prevChange">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <div id="investorInputs" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Nama Investor</label>
                                <input type="text" class="form-control" id="investorNameInput" placeholder="Nama Investor">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-warning w-100 fw-bold text-dark mt-3">PROSES MODAL</button>
                    </form>
                </div>
            </div>

            <!-- Tabel Modal Sendiri -->
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between">
                    <span><i class="fas fa-user-shield"></i> MODAL SENDIRI</span>
                    <span id="displayOwnerBalance">Rp 0</span>
                </div>
                <div class="card-body text-center p-2 text-muted small">
                    Uang ini aman milik kita pribadi.
                </div>
            </div>

            <!-- Tabel Investor -->
            <h5 class="text-white fw-bold mb-3">DAFTAR INVESTOR</h5>
            <div id="investorListContainer"></div>

        </div>

    </div>

    <!-- PAYMENT MODAL (NEW) -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-success"><i class="fas fa-money-bill-wave"></i> Bayar Cicilan / Lunas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="payLoanId">
                    
                    <div class="mb-3 text-center">
                        <small class="text-muted">Total Tagihan Saat Ini</small>
                        <h3 class="fw-bold text-white" id="payTotalBill">Rp 0</h3>
                        <small class="text-danger" id="payLateText"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Jenis Pembayaran</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="payType" id="payTypePrincipal" value="principal" checked>
                            <label class="btn btn-outline-success" for="payTypePrincipal">Cicil Pokok</label>

                            <input type="radio" class="btn-check" name="payType" id="payTypeProfit" value="profit">
                            <label class="btn btn-outline-warning" for="payTypeProfit">Bayar Admin/Denda</label>
                        </div>
                        <div class="form-text mt-1 text-light" id="payTypeDesc">
                            <small><em>Mengurangi pokok utang. Uang kembali ke saldo modal.</em></small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nominal Bayar (Rp)</label>
                        <input type="number" class="form-control fw-bold text-success fs-4" id="payAmount" placeholder="0">
                        <div class="d-flex justify-content-between mt-1">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fillPayAmount('admin')">Bayar Admin Aja</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fillPayAmount('full')">Lunas Semua</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-success w-100 fw-bold" onclick="submitPayment()">PROSES PEMBAYARAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BLACKLIST AREA -->
    <div class="card mt-5 border-danger bg-dark" id="blacklistArea" style="display:none;">
        <div class="card-header text-danger fw-bold border-bottom border-danger">
            <i class="fas fa-ban"></i> DAFTAR BLACKLIST
        </div>
        <ul class="list-group list-group-flush bg-dark" id="blacklistList"></ul>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- DATABASE V6 (Added paidAmount field) ---
    // loans struct: { ..., paidAmount: 0, paidProfit: 0, ... }
    let loans = JSON.parse(localStorage.getItem('loans_v6')) || [];
    let transactions = JSON.parse(localStorage.getItem('transactions_v6')) || [];
    let blacklist = JSON.parse(localStorage.getItem('blacklist_v6')) || [];
    let investors = JSON.parse(localStorage.getItem('investors_v6')) || [];
    let owner = JSON.parse(localStorage.getItem('owner_v6')) || { balance: 0 };

    // --- DOM Elements ---
    const activeContainer = document.getElementById('activeLoanContainer');
    const transactionContainer = document.getElementById('transactionContainer');
    const investorContainer = document.getElementById('investorListContainer');
    const sourceListContainer = document.getElementById('sourceListContainer');
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    
    // --- 1. NAVIGASI ---
    function showSection(sectionId, linkElement) {
        ['dashboardSection', 'activeSection', 'inputSection', 'historySection', 'investSection'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        document.getElementById(sectionId).style.display = 'block';

        if(linkElement) {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            linkElement.classList.add('active');
        }

        if(sectionId === 'inputSection') {
            renderSourceCheckboxes();
            document.getElementById('sourceListContainer').style.display = 'none';
            document.getElementById('dropdownIcon').className = 'fas fa-chevron-down';
            document.getElementById('dropdownLabel').innerText = 'Klik untuk Pilih Sumber Dana...';
            document.getElementById('dropdownLabel').classList.remove('text-white');
            document.getElementById('totalSelectedFunds').innerText = 'Total Dana Terpilih: Rp 0';
        }
        
        updateDashboard();
        if(sectionId === 'activeSection') renderActiveLoans();
        if(sectionId === 'historySection') renderTransactions('in'); 
        if(sectionId === 'investSection') renderInvestments();
        
        const sidebar = document.getElementById('sidebarMenu');
        const bsOffcanvas = bootstrap.Offcanvas.getInstance(sidebar);
        if(bsOffcanvas) bsOffcanvas.hide();
    }

    // --- 2. LOGGING ---
    function logTransaction(type, description, amount, from, to) {
        const now = new Date();
        const log = { id: Date.now() + Math.random(), type: type, description: description, amount: amount, from: from, to: to, timestamp: now.toISOString() };
        transactions.push(log);
        saveAll();
    }

    // --- 3. INPUT MODAL ---
    document.getElementById('capitalType').addEventListener('change', function() {
        if(this.value === 'owner') {
            document.getElementById('ownerInputs').style.display = 'block';
            document.getElementById('investorInputs').style.display = 'none';
            document.getElementById('capitalAmountLabel').innerText = "Total Uang Cash (Rp)";
        } else {
            document.getElementById('ownerInputs').style.display = 'none';
            document.getElementById('investorInputs').style.display = 'block';
            document.getElementById('capitalAmountLabel').innerText = "Jumlah Modal (Rp)";
        }
    });

    const capAmountInput = document.getElementById('capitalAmount');
    const adminCheck = document.getElementById('adminFeeCheck');
    const previewBox = document.getElementById('smartTopupPreview');

    function updateSmartPreview() {
        const type = document.getElementById('capitalType').value;
        const amount = parseInt(capAmountInput.value) || 0;
        const isFee = adminCheck.checked;

        if (type === 'owner' && isFee && amount > 1500) {
            previewBox.style.display = 'block';
            const availableForTopup = amount - 1500;
            const topupReal = Math.floor(availableForTopup / 1000) * 1000;
            const change = availableForTopup - topupReal; 
            document.getElementById('prevCash').innerText = formatRupiah(amount);
            document.getElementById('prevSaldo').innerText = formatRupiah(topupReal);
            document.getElementById('prevChange').innerText = formatRupiah(change);
        } else {
            previewBox.style.display = 'none';
        }
    }

    capAmountInput.addEventListener('input', updateSmartPreview);
    adminCheck.addEventListener('change', updateSmartPreview);
    document.getElementById('capitalType').addEventListener('change', updateSmartPreview);

    document.getElementById('capitalForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const type = document.getElementById('capitalType').value;
        let inputAmount = parseInt(document.getElementById('capitalAmount').value);
        let finalAmount = inputAmount;
        let change = 0;
        
        if(type === 'owner') {
            if(document.getElementById('adminFeeCheck').checked) {
                const available = inputAmount - 1500;
                finalAmount = Math.floor(available / 1000) * 1000;
                change = available - finalAmount;
                logTransaction('OUT', 'Biaya Admin Topup', 1500, 'Owner Cash', 'Indomaret');
            }
            owner.balance += finalAmount;
            logTransaction('IN', `Topup Owner (Cash: ${formatRupiah(inputAmount)})`, finalAmount, 'Owner Pocket', 'Saldo Owner');
            let msg = `‚úÖ Saldo Owner Bertambah: ${formatRupiah(finalAmount)}`;
            if(change > 0) msg += `\n\n‚ö†Ô∏è Sisa Receh di Tangan: ${formatRupiah(change)}`;
            alert(msg);
        } else {
            const name = document.getElementById('investorNameInput').value.trim();
            if(!name) { alert("Nama investor wajib diisi!"); return; }
            investors.push({ id: Date.now(), name: name, balance: inputAmount, unsplitProfit: 0 });
            logTransaction('IN', `Modal Masuk Investor: ${name}`, inputAmount, name, `Saldo ${name}`);
            alert(`‚úÖ Investor ${name} Masuk!`);
        }
        saveAll();
        this.reset();
        previewBox.style.display = 'none';
        renderInvestments();
        updateDashboard();
    });

    // --- 4. MULTI-SOURCE LOAN ---
    function toggleSourceDropdown() {
        const container = document.getElementById('sourceListContainer');
        const icon = document.getElementById('dropdownIcon');
        if (container.style.display === 'none') { container.style.display = 'block'; icon.className = 'fas fa-chevron-up'; } else { container.style.display = 'none'; icon.className = 'fas fa-chevron-down'; }
    }

    function renderSourceCheckboxes() {
        sourceListContainer.innerHTML = '';
        addCheckbox('owner', 'OWNER (Kita)', owner.balance);
        investors.forEach(inv => { addCheckbox(inv.id, `Investor: ${inv.name}`, inv.balance); });
    }

    function addCheckbox(id, label, balance) {
        const div = document.createElement('div');
        div.className = 'form-check source-item';
        div.onclick = function(e) {
            if (e.target.type !== 'checkbox') {
                const cb = div.querySelector('input');
                cb.checked = !cb.checked;
                updateTotalSelected();
            }
        };
        const input = document.createElement('input');
        input.className = 'form-check-input me-2';
        input.type = 'checkbox';
        input.value = id;
        input.id = `chk_${id}`;
        input.dataset.balance = balance;
        input.onchange = updateTotalSelected;
        const lbl = document.createElement('label');
        lbl.className = 'form-check-label text-white';
        lbl.style.cursor = 'pointer';
        lbl.htmlFor = `chk_${id}`;
        lbl.innerHTML = `${label} <br><small class="text-success fw-bold">Rp ${balance.toLocaleString()}</small>`;
        div.appendChild(input);
        div.appendChild(lbl);
        sourceListContainer.appendChild(div);
    }

    function updateTotalSelected() {
        const checkboxes = document.querySelectorAll('#sourceListContainer input:checked');
        let total = 0;
        let count = 0;
        checkboxes.forEach(cb => { total += parseInt(cb.dataset.balance); cb.parentElement.classList.add('active'); count++; });
        document.querySelectorAll('#sourceListContainer input:not(:checked)').forEach(cb => { cb.parentElement.classList.remove('active'); });
        document.getElementById('totalSelectedFunds').innerText = `Total Dana Terpilih: ${formatRupiah(total)}`;
        const label = document.getElementById('dropdownLabel');
        if (count === 0) { label.innerText = "Klik untuk Pilih Sumber Dana..."; label.classList.remove('text-white'); } else { label.innerText = `${count} Sumber Dipilih (${formatRupiah(total)})`; label.classList.add('text-white'); }
    }

    document.getElementById('loanForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const amount = parseInt(document.getElementById('amount').value);
        const checkboxes = document.querySelectorAll('#sourceListContainer input:checked');
        if(checkboxes.length === 0) { alert("Pilih minimal 1 sumber dana!"); return; }

        let availableTotal = 0;
        let sources = [];
        checkboxes.forEach(cb => {
            let id = cb.value;
            let currentBal = 0;
            if(id === 'owner') currentBal = owner.balance;
            else { const inv = investors.find(i => i.id == id); if(inv) currentBal = inv.balance; }
            availableTotal += currentBal;
            sources.push({ id: id, balance: currentBal, contribution: 0 });
        });

        if (amount > availableTotal) { alert(`‚õî Saldo gabungan tidak cukup! Cuma ada ${formatRupiah(availableTotal)}`); return; }

        let remainingLoan = amount;
        let activeSources = [...sources];
        while (remainingLoan > 0 && activeSources.length > 0) {
            let sharePerPerson = Math.ceil(remainingLoan / activeSources.length);
            let nextRoundSources = [];
            activeSources.forEach(src => {
                if (remainingLoan <= 0) return;
                let availableToGive = src.balance - src.contribution;
                let takeAmount = Math.min(sharePerPerson, availableToGive);
                takeAmount = Math.min(takeAmount, remainingLoan);
                src.contribution += takeAmount;
                remainingLoan -= takeAmount;
                if (src.balance > src.contribution) nextRoundSources.push(src);
            });
            activeSources = nextRoundSources;
        }

        let contributionLog = [];
        sources.forEach(src => {
            if (src.contribution > 0) {
                if(src.id === 'owner') { owner.balance -= src.contribution; contributionLog.push(`Owner: ${formatRupiah(src.contribution)}`); }
                else { const inv = investors.find(i => i.id == src.id); inv.balance -= src.contribution; contributionLog.push(`${inv.name}: ${formatRupiah(src.contribution)}`); }
            }
        });

        const name = document.getElementById('borrowerName').value.trim().toUpperCase();
        let phone = document.getElementById('borrowerPhone').value.trim();
        phone = phone.replace(/\D/g, '');
        if (phone.startsWith('0')) phone = '62' + phone.substring(1);
        else if (!phone.startsWith('62')) phone = '62' + phone;

        const config = getLoanConfig(amount);
        const now = new Date();
        const dueDate = new Date(now);
        dueDate.setDate(dueDate.getDate() + config.days);

        loans.push({
            id: Date.now(), name, phone, amount,
            maxAdmin: config.admin, dailyRate: config.dailyRate, daysLimit: config.days,
            dateCreated: now.toISOString(), dueDate: dueDate.toISOString(),
            contributors: sources.map(s => ({ id: s.id, amount: s.contribution })).filter(c => c.amount > 0),
            paidAmount: 0 // New Tracker
        });

        logTransaction('OUT', `Pinjaman Keluar ke ${name}`, amount, contributionLog.join(', '), name);
        saveAll(); this.reset(); document.getElementById('previewBox').style.display = 'none'; showSection('activeSection'); alert("‚úÖ Pinjaman Diproses!");
    });

    // --- 5. RENDER LOANS (CICILAN UI) ---
    function renderActiveLoans() {
        activeContainer.innerHTML = '';
        if (loans.length === 0) { document.getElementById('emptyActiveMsg').style.display = 'block'; return; }
        document.getElementById('emptyActiveMsg').style.display = 'none';
        const now = new Date();
        loans.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        loans.forEach(loan => {
            // Fix old data structure compatibility
            if(typeof loan.paidAmount === 'undefined') loan.paidAmount = 0;

            const dueDate = new Date(loan.dueDate);
            const createdDate = new Date(loan.dateCreated);
            let daysElapsed = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24)) || 1;
            let daysLate = Math.ceil((now - dueDate) / (1000 * 60 * 60 * 24));
            let currentAdmin = 0, denda = 0, statusBadge = '', cardClass = 'border-secondary';

            if (daysLate > 0) {
                currentAdmin = loan.maxAdmin; denda = daysLate * 3000; cardClass = 'border-danger';
                statusBadge = `<span class="badge bg-danger blink-urgent">TELAT ${daysLate} HARI</span>`;
                if (daysLate > 2 && !blacklist.includes(loan.name)) { blacklist.push(loan.name); saveAll(); }
            } else {
                currentAdmin = Math.min(daysElapsed * loan.dailyRate, loan.maxAdmin);
                statusBadge = `<span class="badge bg-success">HARI KE-${daysElapsed}</span>`;
            }
            
            const totalBill = loan.amount + currentAdmin + denda;
            const remaining = totalBill - loan.paidAmount;
            const percent = Math.min(100, Math.round((loan.paidAmount / totalBill) * 100));

            activeContainer.innerHTML += `
            <div class="card ${cardClass} mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div><h5 class="fw-bold mb-0 text-white">${loan.name}</h5><small class="text-muted"><i class="fab fa-whatsapp"></i> +${loan.phone}</small></div>${statusBadge}
                    </div>
                    
                    <div class="bg-dark p-2 rounded border border-secondary mb-3">
                        <div class="d-flex justify-content-between small text-muted"><span>Pokok Pinjaman</span> <span>${formatRupiah(loan.amount)}</span></div>
                        <div class="d-flex justify-content-between small text-info"><span>Admin Saat Ini</span> <span>${formatRupiah(currentAdmin)}</span></div>
                        ${denda > 0 ? `<div class="d-flex justify-content-between small text-danger fw-bold"><span>Denda</span> <span>${formatRupiah(denda)}</span></div>` : ''}
                        
                        <div class="border-top border-secondary my-2"></div>
                        
                        <div class="d-flex justify-content-between small text-white"><span>Total Tagihan</span> <span>${formatRupiah(totalBill)}</span></div>
                        <div class="d-flex justify-content-between small text-success"><span>Sudah Dibayar</span> <span>- ${formatRupiah(loan.paidAmount)}</span></div>
                        
                        <div class="border-top border-secondary mt-1 pt-1 d-flex justify-content-between fw-bold text-white fs-5">
                            <span>SISA</span> <span class="text-warning">${formatRupiah(remaining)}</span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="progress mt-2">
                            <div class="progress-bar bg-success" role="progressbar" style="width: ${percent}%"></div>
                        </div>
                        <small class="text-muted" style="font-size: 0.7rem;">Terbayar: ${percent}%</small>
                    </div>

                    <div class="row g-2">
                        <div class="col-12">
                            <button onclick="transferDana('${loan.phone}', ${loan.amount})" class="btn btn-primary w-100 fw-bold mb-2"><i class="fas fa-paper-plane"></i> CAIRKAN (DANA)</button>
                        </div>
                        <div class="col-6"><button onclick="kirimWA('${loan.name}', '${loan.phone}', ${loan.amount}, ${currentAdmin}, ${denda}, ${remaining}, ${daysLate})" class="btn btn-outline-success w-100 fw-bold"><i class="fab fa-whatsapp"></i> TAGIH</button></div>
                        <div class="col-6"><button onclick="openPaymentModal(${loan.id})" class="btn btn-success w-100 fw-bold"><i class="fas fa-money-bill"></i> BAYAR</button></div>
                    </div>
                </div>
            </div>`;
        });
    }

    function transferDana(phone, amount) {
        let cleanPhone = phone.replace(/\D/g, '');
        if (!cleanPhone.startsWith('62') && !cleanPhone.startsWith('0')) { cleanPhone = '0' + cleanPhone; }
        navigator.clipboard.writeText(cleanPhone).then(() => {
            if(confirm(`Nomor ${cleanPhone} sudah dicopy!\n\nKarena kebijakan keamanan DANA, 'Auto-Isi' sering diblokir. Silakan PASTE nomornya manual.\n\nBuka aplikasi DANA sekarang?`)) {
                window.location.href = "https://link.dana.id/sendmoney";
            }
        }, () => {
            prompt("Gagal copy otomatis. Copy nomor ini manual:", cleanPhone);
            window.location.href = "https://link.dana.id/sendmoney";
        });
    }

    function renderTransactions(filterType) {
        transactionContainer.innerHTML = '';
        const filtered = transactions.filter(t => filterType === 'in' ? t.type === 'IN' : t.type === 'OUT');
        if (filtered.length === 0) { transactionContainer.innerHTML = '<p class="text-center text-muted py-5">Belum ada data transaksi ini.</p>'; return; }
        filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        filtered.forEach(log => {
            const dateObj = new Date(log.timestamp);
            const dateStr = dateObj.toLocaleDateString('id-ID');
            const timeStr = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute:'2-digit' });
            const logClass = log.type === 'IN' ? 'log-in' : 'log-out';
            const html = `<div class="card mb-2 border-0 bg-dark border-bottom border-secondary rounded-0 ${logClass}"><div class="card-body py-2 px-3"><div class="d-flex justify-content-between align-items-center"><span class="fw-bold text-white small">${log.description}</span><span class="${log.type==='IN'?'text-success':'text-danger'} fw-bold">${log.type==='IN'?'+':'-'}${formatRupiah(log.amount)}</span></div><div class="d-flex justify-content-between align-items-center mt-1"><span class="log-date"><i class="far fa-clock"></i> ${dateStr} ${timeStr}</span><span class="log-date text-end">From: ${log.from} <i class="fas fa-long-arrow-alt-right"></i> To: ${log.to}</span></div></div></div>`;
            transactionContainer.innerHTML += html;
        });
    }

    // --- 6. NEW PAYMENT SYSTEM (CICILAN) ---
    
    // UI RADIO HANDLER
    document.querySelectorAll('input[name="payType"]').forEach((elem) => {
        elem.addEventListener("change", function(event) {
            const desc = document.getElementById('payTypeDesc');
            if (event.target.value === "principal") {
                desc.innerHTML = "<small><em>Mengurangi pokok utang. Uang kembali ke saldo modal (diputar lagi).</em></small>";
            } else {
                desc.innerHTML = "<small><em>Bayar Admin/Denda duluan. Uang masuk ke Profit (siap bagi hasil).</em></small>";
            }
        });
    });

    let currentPayLoanId = null;
    let currentAdminVal = 0;
    let currentRemainingVal = 0;

    function openPaymentModal(id) {
        const loan = loans.find(l => l.id === id);
        if(!loan) return;
        currentPayLoanId = id;

        // Calc current Values
        const now = new Date();
        const createdDate = new Date(loan.dateCreated);
        let elapsed = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24)) || 1;
        let late = Math.ceil((now - new Date(loan.dueDate)) / (1000 * 60 * 60 * 24));
        let admin = (late > 0) ? loan.maxAdmin : Math.min(elapsed * loan.dailyRate, loan.maxAdmin);
        let denda = (late > 0) ? late * 3000 : 0;
        let totalBill = loan.amount + admin + denda;
        let remaining = totalBill - (loan.paidAmount || 0);

        currentAdminVal = admin + denda;
        currentRemainingVal = remaining;

        document.getElementById('payTotalBill').innerText = formatRupiah(remaining);
        document.getElementById('payLoanId').value = id;
        document.getElementById('payAmount').value = "";
        
        if (late > 0) {
            document.getElementById('payLateText').innerText = `‚ö†Ô∏è Telat ${late} Hari (Denda ${formatRupiah(denda)})`;
        } else {
            document.getElementById('payLateText').innerText = "";
        }

        paymentModal.show();
    }

    function fillPayAmount(type) {
        if(type === 'admin') document.getElementById('payAmount').value = currentAdminVal;
        if(type === 'full') document.getElementById('payAmount').value = currentRemainingVal;
    }

    function submitPayment() {
        const amount = parseInt(document.getElementById('payAmount').value);
        if(!amount || amount <= 0) { alert("Masukkan nominal yang valid!"); return; }
        
        const type = document.querySelector('input[name="payType"]:checked').value;
        const loanIndex = loans.findIndex(l => l.id === currentPayLoanId);
        if(loanIndex === -1) return;
        
        const loan = loans[loanIndex];
        
        // Update Paid Amount
        if(typeof loan.paidAmount === 'undefined') loan.paidAmount = 0;
        loan.paidAmount += amount;

        // DISTRIBUTE FUNDS
        // Logic:
        // If Type = Principal -> Return to Contributors' Balance
        // If Type = Profit -> Add to Profit (Unsplit) or Owner Balance (Profit share)
        
        // Simplified Logic:
        // Profit payments ALSO go to balance (cash is cash), but we tag it for profit distribution.
        
        let logDesc = "";

        if (type === 'profit') {
            logDesc = `Bayar Admin/Denda: ${loan.name}`;
            // Distribusi Profit (50:50 logic, or just hold in unsplit?)
            // Let's assume profit payment is split proportionally based on contribution
            loan.contributors.forEach(contrib => {
                let sharePct = contrib.amount / loan.amount;
                let shareAmt = amount * sharePct;
                
                if(contrib.id === 'owner') {
                    owner.balance += shareAmt; // Owner profit just sits in balance
                } else {
                    const inv = investors.find(i => i.id == contrib.id);
                    if(inv) {
                        inv.balance += shareAmt; // Cash back to balance
                        inv.unsplitProfit += shareAmt; // Track as profit to be split later
                    } else {
                        owner.balance += shareAmt;
                    }
                }
            });
        } else {
            logDesc = `Cicilan Pokok: ${loan.name}`;
            // Return Principal to Balance
            loan.contributors.forEach(contrib => {
                let sharePct = contrib.amount / loan.amount;
                let shareAmt = amount * sharePct;
                
                if(contrib.id === 'owner') {
                    owner.balance += shareAmt;
                } else {
                    const inv = investors.find(i => i.id == contrib.id);
                    if(inv) inv.balance += shareAmt;
                    else owner.balance += shareAmt;
                }
            });
        }

        logTransaction('IN', logDesc, amount, loan.name, 'System/Investors');

        // Check if Fully Paid
        // Recalculate Total Bill to be sure
        const now = new Date();
        const createdDate = new Date(loan.dateCreated);
        let elapsed = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24)) || 1;
        let late = Math.ceil((now - new Date(loan.dueDate)) / (1000 * 60 * 60 * 24));
        let admin = (late > 0) ? loan.maxAdmin : Math.min(elapsed * loan.dailyRate, loan.maxAdmin);
        let denda = (late > 0) ? late * 3000 : 0;
        let totalBill = loan.amount + admin + denda;

        if (loan.paidAmount >= totalBill) {
            alert("üéâ LUNAS! Utang ini sudah selesai.");
            // Move to history
             history.push({
                ...loan, datePaid: new Date().toISOString(),
                finalAdmin: admin, finalDenda: denda, totalPaid: loan.paidAmount
            });
            loans.splice(loanIndex, 1);
        } else {
            alert("‚úÖ Pembayaran Diterima. Sisa tagihan berkurang.");
        }

        saveAll();
        paymentModal.hide();
        renderActiveLoans();
        updateDashboard();
    }

    function renderInvestments() {
        investorContainer.innerHTML = '';
        if(investors.length === 0) { investorContainer.innerHTML = '<p class="text-muted text-center small">Belum ada investor.</p>'; return; }
        investors.forEach((inv, idx) => {
            const html = `<div class="card border-info mb-2"><div class="card-body py-2"><div class="d-flex justify-content-between align-items-center mb-2"><span class="fw-bold text-white">${inv.name}</span><div class="text-end"><small class="text-muted d-block" style="font-size:0.6rem">SALDO READY</small><span class="text-info fw-bold">${formatRupiah(inv.balance)}</span></div></div><div class="bg-dark p-2 rounded border border-secondary mb-2"><div class="d-flex justify-content-between align-items-center"><span class="small text-success">Profit Belum Dibagi:</span><span class="fw-bold text-success">${formatRupiah(inv.unsplitProfit)}</span></div></div><div class="row g-1"><div class="col-10"><button onclick="bagiHasil(${idx})" class="btn btn-sm btn-success w-100 fw-bold" ${inv.unsplitProfit <= 0 ? 'disabled' : ''}><i class="fas fa-hand-holding-usd"></i> BAGI HASIL (50:50)</button></div><div class="col-2"><button onclick="hapusInvestor(${idx})" class="btn btn-sm btn-outline-danger w-100"><i class="fas fa-trash"></i></button></div></div></div></div>`;
            investorContainer.innerHTML += html;
        });
        document.getElementById('displayOwnerBalance').innerText = formatRupiah(owner.balance);
    }

    function bagiHasil(index) {
        const inv = investors[index];
        if (inv.unsplitProfit <= 0) return;
        const totalProfit = inv.unsplitProfit;
        const splitAmount = totalProfit / 2;
        if(confirm(`BAGI HASIL INVESTOR: ${inv.name}\nTotal Profit: ${formatRupiah(totalProfit)}\n\n50% ke Investor (Tetap)\n50% ke Owner (${formatRupiah(splitAmount)}) - PINDAH\n\nLanjutkan?`)) {
            if (inv.balance < splitAmount) { alert("Saldo investor kurang (sedang diputar)."); return; }
            inv.balance -= splitAmount; owner.balance += splitAmount; inv.unsplitProfit = 0;
            logTransaction('OUT', `Bagi Hasil (Masuk Owner): ${inv.name}`, splitAmount, `Saldo ${inv.name}`, 'Saldo Owner');
            saveAll(); renderInvestments(); updateDashboard();
        }
    }

    function hapusInvestor(index) { if(confirm("Hapus investor ini?")) { investors.splice(index, 1); saveAll(); renderInvestments(); updateDashboard(); } }

    function updateDashboard() {
        let invBalance = investors.reduce((acc, curr) => acc + curr.balance, 0);
        
        // Calculate USED Amount correctly (Total Loan - Total Paid Partial)
        let usedAmount = loans.reduce((acc, curr) => acc + (curr.amount - (curr.paidAmount || 0)), 0); 
        // Note: paidAmount includes admin/profit payments too, so this is an approximation of "Outstanding Cash".
        // A better approximation for "Money Out" is strictly Loan Amount - Principal Repaid. 
        // But for simplicity in V6, we use the raw remaining balance logic or stick to V5 logic:
        // V5 logic: Used = Total Loan Amounts.
        // V6 logic: When partial payment happens, money goes BACK to balance. So 'Available' increases immediately.
        // Therefore 'Total Asset' = Available + Outstanding Loans.
        
        let outstandingPrincipal = loans.reduce((acc, curr) => acc + curr.amount, 0); 
        // Wait, if they pay principal, we should probably reduce the tracked amount? 
        // No, we tracked contributions. In submitPayment we returned money to balance.
        // So Balance is accurate.
        // We just need to display "Dipinjam Orang" as the total outstanding principal?
        // Let's keep it simple: Total Asset = Owner Balance + Investor Balance + Outstanding Loans.
        // Since we returned money to balance on partial payment, Outstanding Loans should functionally decrease?
        // Actually, in `submitPayment`, we add to `balance`. So the money is in `balance`.
        // So `dashUsed` should represent money that is NOT in balance but is expected to come back (Principal).
        // Since we didn't track "Principal Remaining" strictly in database, let's just show Total Asset.
        
        let totalAvailable = owner.balance + invBalance;
        
        document.getElementById('dashAvailable').innerText = formatRupiah(totalAvailable);
        
        // Fix Asset Calculation for V6
        // Asset = Uang di Tangan (Available) + Uang di Luar (Outstanding Principal)
        // Outstanding Principal = Initial Loan - Principal Repaid.
        // Since we don't strictly track Principal Repaid vs Profit Repaid in the loan object structure easily without complex logic,
        // Let's rely on: Asset = Initial Capital + Profit Realized.
        // But "Profit Realized" is hard to track globally.
        // Simplest: Just sum Owner Balance + Investor Balance + Sum(Active Loans Remaining Principal).
        // Approximation: Sum(Active Loans Amount) - (Sum(Active Loans Paid) * maybe?)
        // Let's stick to V5 logic for visual consistency: Used = Sum of Loan Amounts.
        // (Even if partially paid, the loan is still "Active").
        let simpleUsed = loans.reduce((acc, curr) => acc + curr.amount, 0); 
        document.getElementById('dashUsed').innerText = formatRupiah(simpleUsed);
        
        // Total Asset = Available + Simple Used (Roughly).
        document.getElementById('dashTotalAsset').innerText = formatRupiah(totalAvailable + simpleUsed);

        document.getElementById('dashOwnerBalance').innerText = formatRupiah(owner.balance);
        document.getElementById('dashInvestorBalance').innerText = formatRupiah(invBalance);
    }

    function getLoanConfig(amount) {
        if (amount < 10000) return { error: "Min 10k!" };
        if (amount > 100000) return { error: "Max 100k!" };
        if (amount < 20000) return { admin: 3000, days: 2, dailyRate: 2000 };
        if (amount < 30000) return { admin: 7000, days: 3, dailyRate: 3000 };
        if (amount < 40000) return { admin: 12000, days: 4, dailyRate: 3000 };
        if (amount < 70000) return { admin: 17000, days: 5, dailyRate: 4000 };
        if (amount < 90000) return { admin: 25000, days: 6, dailyRate: 5000 };
        if (amount <= 100000) return { admin: 30000, days: 7, dailyRate: 5000 };
        return { error: "Nominal error." };
    }

    document.getElementById('amount').addEventListener('input', function() {
        const val = parseInt(this.value);
        const previewDiv = document.getElementById('previewBox');
        if (!val) { previewDiv.style.display = 'none'; return; }
        const config = getLoanConfig(val);
        previewDiv.style.display = 'block';
        if (config.error) { previewDiv.innerHTML = `<span class="text-danger fw-bold">${config.error}</span>`; }
        else { previewDiv.innerHTML = `<div class="row text-center text-white"><div class="col-4 border-end border-secondary"><small class="text-muted d-block">Rate/Hari</small><span class="text-warning fw-bold">${formatRupiah(config.dailyRate)}</span></div><div class="col-4 border-end border-secondary"><small class="text-muted d-block">Max Admin</small><span>${formatRupiah(config.admin)}</span></div><div class="col-4"><small class="text-muted d-block">Tempo</small><span>${config.days} Hari</span></div></div>`; }
    });

    function kirimWA(name, phone, pokok, admin, denda, total, late) {
        let msg = (late > 0) ? `WOI *${name}*! üò°\nTelat *${late} hari*.\nTotal: *${formatRupiah(total)}*.\nBayar sekarang!` : `Halo *${name}*, reminder utang.\nTotal: *${formatRupiah(total)}*.\nMakasih.`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function resetData() { if(confirm("RESET TOTAL (Hapus Semua)?")) { localStorage.clear(); location.reload(); } }
    function saveAll() { localStorage.setItem('loans_v6', JSON.stringify(loans)); localStorage.setItem('transactions_v6', JSON.stringify(transactions)); localStorage.setItem('blacklist_v6', JSON.stringify(blacklist)); localStorage.setItem('investors_v6', JSON.stringify(investors)); localStorage.setItem('owner_v6', JSON.stringify(owner)); }
    function formatRupiah(num) { return "Rp " + num.toLocaleString('id-ID'); }

    renderSourceCheckboxes();
    updateDashboard();
    showSection('dashboardSection', document.querySelector('.nav-link.active'));
</script>
</body>
</html>
